{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Registro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}

{% block content %}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card p-4">
                <div class="card-body">
                    <div class="card-body text-center">
                        <img src="{% static 'img/registro-icon.png' %}" alt="Avatar de usuario" class="rounded-circle shadow-sm" width="70" height="70">
                    </div>
                    <h2 class="fw-bold text-primary text-center mt-3">Crear cuenta</h2>

                   <form method="post" novalidate>
                        {% csrf_token %}
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                        {% endif %}

                        <div class="mb-3">
                            {{ form.username.label_tag }}
                            <div class="position-relative">
                                {{ form.username|add_class:"form-control"|attr:"autocomplete:off" }}
                                <div class="spinner-border spinner-border-sm text-primary position-absolute top-50 end-0 translate-middle-y me-2 d-none" id="usernameSpinner" role="status">
                                    <span class="visually-hidden">Verificando...</span>
                                </div>
                            </div>
                            <div class="small text-danger mt-1" id="usernameFeedback" style="display: none;"></div>
                            <div class="small text-success mt-1" id="usernameSuccess" style="display: none;">¡Nombre de usuario disponible!</div>
                        </div>

                        <div class="mb-3">
                            {{ form.email.label_tag }}
                            {{ form.email|add_class:"form-control" }}
                            <div class="invalid-feedback">Ingrese un correo electrónico válido.</div>
                        </div>

                        <div class="mb-3">
                            {{ form.password1.label_tag }}
                            {{ form.password1|add_class:"form-control"|attr:"type:password" }}
                            <div id="password-feedback" class="password-feedback mt-2" style="display: none;"></div>
                            <div class="password-requirements mt-2">
                                <p class="mb-1 text-muted"><small>La contraseña debe tener:</small></p>
                                <ul class="list-group list-group-flush small border-0">
                                    <li id="req-length" class="list-group-item text-muted border-0 py-1 px-0">
                                        <i class="bi bi-dot me-2"></i>Al menos 8 caracteres
                                    </li>
                                    <li id="req-uppercase" class="list-group-item text-muted border-0 py-1 px-0">
                                        <i class="bi bi-dot me-2"></i>Una letra mayúscula
                                    </li>
                                    <li id="req-lowercase" class="list-group-item text-muted border-0 py-1 px-0">
                                        <i class="bi bi-dot me-2"></i>Una letra minúscula
                                    </li>
                                    <li id="req-number" class="list-group-item text-muted border-0 py-1 px-0">
                                        <i class="bi bi-dot me-2"></i>Un número
                                    </li>
                                    <li id="req-special" class="list-group-item text-muted border-0 py-1 px-0">
                                        <i class="bi bi-dot me-2"></i>Un símbolo (ej: @#$%)
                                    </li>
                                </ul>
                            </div>
                            <div class="invalid-feedback">La contraseña debe cumplir con todos los requisitos.</div>
                        </div>

                        <div class="mb-3">
                            {{ form.password2.label_tag }}
                            {{ form.password2|add_class:"form-control"|attr:"type:password" }}
                            <div class="invalid-feedback">Las contraseñas no coinciden.</div>
                        </div>

                        <hr class="my-4">
                        <h4 class="mb-3">Preguntas de seguridad</h4>
                        <p class="text-muted small mb-3">Estas preguntas te ayudarán a recuperar tu cuenta si olvidas tu contraseña.</p>

                        {% if security_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ security_form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <label class="form-label">Pregunta de seguridad 1</label>
                            {{ security_form.pregunta1|add_class:"form-select" }}
                            <label class="form-label mt-2">Tu respuesta</label>
                            {{ security_form.respuesta1|add_class:"form-control" }}
                            {% if security_form.pregunta1.errors or security_form.respuesta1.errors %}
                            <div class="invalid-feedback d-block">
                                {{ security_form.pregunta1.errors }} {{ security_form.respuesta1.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Pregunta de seguridad 2</label>
                            {{ security_form.pregunta2|add_class:"form-select" }}
                            <label class="form-label mt-2">Tu respuesta</label>
                            {{ security_form.respuesta2|add_class:"form-control" }}
                            {% if security_form.pregunta2.errors or security_form.respuesta2.errors %}
                            <div class="invalid-feedback d-block">
                                {{ security_form.pregunta2.errors }} {{ security_form.respuesta2.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Pregunta de seguridad 3</label>
                            {{ security_form.pregunta3|add_class:"form-select" }}
                            <label class="form-label mt-2">Tu respuesta</label>
                            {{ security_form.respuesta3|add_class:"form-control" }}
                            {% if security_form.pregunta3.errors or security_form.respuesta3.errors %}
                            <div class="invalid-feedback d-block">
                                {{ security_form.pregunta3.errors }} {{ security_form.respuesta3.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Registrarse</button>
                    </form>

                    <p class="text-center mt-3 form-subtext">
                        ¿Ya tienes cuenta? <a href="{% url 'login' %}">Inicia sesión</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const password1Input = document.getElementById('id_password1');
    const password2Input = document.getElementById('id_password2');

    if (password1Input) {
        password1Input.addEventListener('input', function(e) {
            validarRequisitosPassword(e.target.value, e.target);
        });
    }

    if (password2Input) {
        password2Input.addEventListener('input', function(e) {
            validarConfirmacionPassword();
        });
    }
});

function validarRequisitosPassword(valor, input) {
    const requisitos = {
        "req-length": { test: valor.length >= 8, mensaje: 'Al menos 8 caracteres' },
        "req-uppercase": { test: /[A-Z]/.test(valor), mensaje: 'Una letra mayúscula' },
        "req-lowercase": { test: /[a-z]/.test(valor), mensaje: 'Una letra minúscula' },
        "req-number": { test: /\d/.test(valor), mensaje: 'Un número' },
        "req-special": { test: /[\W_]/.test(valor), mensaje: 'Un símbolo (ej: @#$%)' }
    };

    const requisitosFaltantes = [];

    Object.entries(requisitos).forEach(([reqId, req]) => {
        const li = document.getElementById(reqId);
        const icon = li.querySelector("i");
        
        if (req.test) {
            li.classList.remove("text-muted", "text-danger");
            li.classList.add("text-success");
            icon.classList.replace("bi-dot", "bi-check-circle-fill");
            icon.classList.replace("bi-x-circle-fill", "bi-check-circle-fill");
        } else {
            li.classList.remove("text-success", "text-muted");
            li.classList.add("text-danger");
            icon.classList.replace("bi-check-circle-fill", "bi-x-circle-fill");
            icon.classList.replace("bi-dot", "bi-x-circle-fill");
            requisitosFaltantes.push(req.mensaje);
        }
    });

    const feedback = document.getElementById('password-feedback');
    
    input.classList.remove("is-valid", "is-invalid");
    if (valor.length > 0) {
        if (requisitosFaltantes.length > 0) {
            input.classList.add("is-invalid");
            input.style.borderColor = "#dc3545";
            input.style.boxShadow = "0 0 0 0.25rem rgba(220, 53, 69, 0.25)";
            feedback.innerHTML = `Requisitos faltantes:<br>${requisitosFaltantes.map(req => `• ${req}`).join('<br>')}`;
            feedback.style.display = 'block';
        } else {
            input.classList.add("is-valid");
            input.style.borderColor = "#198754";
            input.style.boxShadow = "0 0 0 0.25rem rgba(25, 135, 84, 0.25)";
            feedback.style.display = 'none';
        }
    } else {
        input.style.borderColor = "";
        input.style.boxShadow = "";
        feedback.style.display = 'none';
    }

    // Validar si la contraseña de confirmación coincide
    const password2Input = document.getElementById('id_password2');
    if (password2Input.value) {
        validarConfirmacionPassword();
    }

    return requisitosFaltantes.length === 0;
}

function validarCampo(inputId, regex, mensaje, compararCon = null) {
    const input = document.getElementById(inputId);
    const feedback = input.nextElementSibling;

    function validar() {
        let valido = true;
        if (regex) valido = regex.test(input.value);
        if (compararCon) {
            const comparador = document.getElementById(compararCon);
            valido = valido && (input.value === comparador.value);
        }
        if (valido || input.value.length === 0) {
            input.classList.remove("is-invalid");
        } else {
            input.classList.add("is-invalid");
        }
    }

    input.addEventListener("input", validar);
    if (compararCon) document.getElementById(compararCon).addEventListener("input", validar);
}

// Función de debounce para evitar múltiples llamadas
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Función para verificar disponibilidad del username
async function verificarUsername(username) {
    const input = document.getElementById('id_username');
    const spinner = document.getElementById('usernameSpinner');
    const invalidFeedback = document.getElementById('usernameFeedback');
    const validFeedback = document.getElementById('usernameSuccess');
    
    // Ocultar los mensajes primero
    invalidFeedback.style.display = 'none';
    validFeedback.style.display = 'none';
    
    // Si el username está vacío o no cumple con el formato
    if (!username || !/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
        input.classList.remove('is-valid', 'is-invalid');
        if (username) {
            input.classList.add('is-invalid');
            invalidFeedback.textContent = 'Debe contener solo letras, números o guion bajo, entre 3 y 20 caracteres.';
            invalidFeedback.style.display = 'block';
        }
        return;
    }

    try {
        spinner.classList.remove('d-none');
        const response = await fetch(`/check_username/?username=${encodeURIComponent(username)}`);
        const data = await response.json();

        input.classList.remove('is-valid', 'is-invalid');
        if (data.available) {
            input.classList.add('is-valid');
            validFeedback.style.display = 'block';
        } else {
            input.classList.add('is-invalid');
            invalidFeedback.textContent = 'Este nombre de usuario ya está en uso.';
            invalidFeedback.style.display = 'block';
        }
    } catch (error) {
        console.error('Error al verificar username:', error);
    } finally {
        spinner.classList.add('d-none');
    }
}

// Aplicar debounce a la verificación de username (300ms)
const debouncedVerificarUsername = debounce(verificarUsername, 300);

// Event listener para el campo de username
const usernameInput = document.getElementById('id_username');
if (usernameInput) {
    usernameInput.addEventListener('input', (e) => {
        debouncedVerificarUsername(e.target.value);
    });
}

validarCampo("id_email", /^[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}$/, "Ingrese un correo electrónico válido.");

// Validación de contraseña
const password1Input = document.getElementById('id_password1');
if (password1Input) {
    ['input', 'keyup', 'change'].forEach(event => {
        password1Input.addEventListener(event, (e) => {
            validarRequisitosPassword(e.target.value, e.target);
        });
    });
}

// Función para validar la confirmación de contraseña
function validarConfirmacionPassword() {
    const password1 = document.getElementById('id_password1');
    const password2 = document.getElementById('id_password2');
    const feedback = password2.nextElementSibling;

    password2.classList.remove("is-valid", "is-invalid");
    
    if (password2.value) {
        if (password2.value === password1.value) {
            password2.classList.add("is-valid");
            password2.style.borderColor = "#198754";
            password2.style.boxShadow = "0 0 0 0.25rem rgba(25, 135, 84, 0.25)";
            feedback.style.display = 'none';
        } else {
            password2.classList.add("is-invalid");
            password2.style.borderColor = "#dc3545";
            password2.style.boxShadow = "0 0 0 0.25rem rgba(220, 53, 69, 0.25)";
            feedback.style.display = 'block';
        }
    } else {
        password2.style.borderColor = "";
        password2.style.boxShadow = "";
        feedback.style.display = 'none';
    }
}

// Event listeners para la confirmación de contraseña
const password2Input = document.getElementById('id_password2');
if (password2Input) {
    ['input', 'keyup', 'change'].forEach(event => {
        password2Input.addEventListener(event, validarConfirmacionPassword);
    });
}


</script>

<style>
.password-requirements .list-group-item {
    font-size: 0.875rem;
    background-color: transparent;
}

.text-success {
    color: #198754 !important;
}

.text-muted {
    color: #6c757d !important;
}

.text-danger {
    color: #dc3545 !important;
}

.password-requirements .bi-check-circle-fill {
    color: #198754 !important;
    font-size: 1rem;
}

.password-requirements .bi-dot,
.password-requirements .bi-x-circle-fill {
    font-size: 1rem;
    line-height: 0;
    vertical-align: middle;
    margin-top: -2px;
}

.password-requirements .bi-x-circle-fill {
    color: #dc3545 !important;
}

.form-control {
    padding-left: 0.75rem !important;
}

.input-group .btn {
    z-index: 0;
}

.input-group .btn:focus {
    box-shadow: none;
}

.input-group .btn:hover {
    background-color: transparent;
}

.form-control.is-valid,
.form-control.is-invalid {
    padding-right: 2.5rem !important;
    background-position: right calc(0.375em + 0.1875rem) center !important;
    background-repeat: no-repeat;
    background-size: calc(1em + 0.375rem) calc(1em + 0.375rem);
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.password-feedback {
    background-color: #fff;
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-top: 0.5rem;
    border: 1px solid #dc3545;
    color: #dc3545;
    font-size: 0.875rem;
    line-height: 1.5;
}

.form-control.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
}

.form-control.is-valid {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25) !important;
}
</style>

{% endblock %}